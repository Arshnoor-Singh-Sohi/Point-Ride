{% extends 'base.html' %}

{% block title %}Route Planning - pointRide{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <!-- Left Panel: Simplified Route Creation -->
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5>üó∫Ô∏è Create Ride with Route Planning</h5>
                    <p class="text-muted mb-0">Select cities on the map or use the form below</p>
                </div>
                <div class="card-body">
                    <!-- Single Streamlined Form -->
                    <form method="post" action="{% url 'rides:create_ride' %}" id="streamlinedRideForm">
                        {% csrf_token %}
                        
                        <!-- Route Selection -->
                        <div class="mb-3">
                            <label class="form-label fw-semibold">From City</label>
                            <select name="pickup_city" id="originSelect" class="form-control" required>
                                <option value="">Select pickup city</option>
                                {% for city in cities %}
                                    <option value="{{ city.id }}" data-lat="{{ city.latitude }}" data-lng="{{ city.longitude }}">
                                        {{ city.name }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label fw-semibold">To City</label>
                            <select name="dropoff_city" id="destinationSelect" class="form-control" required>
                                <option value="">Select destination city</option>
                                {% for city in cities %}
                                    <option value="{{ city.id }}" data-lat="{{ city.latitude }}" data-lng="{{ city.longitude }}">
                                        {{ city.name }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <!-- Specific Locations with Google API -->
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Pickup Location</label>
                            <input type="text" name="pickup_location" id="pickupLocationInput" class="form-control" required placeholder="e.g., Union Station, Toronto">
                            <div class="form-text">Start typing for suggestions</div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Drop-off Location</label>
                            <input type="text" name="dropoff_location" id="dropoffLocationInput" class="form-control" required placeholder="e.g., Rideau Centre, Ottawa">
                            <div class="form-text">Start typing for suggestions</div>
                        </div>
                        
                        <!-- Ride Details -->
                        <div class="row">
                            <div class="col-6">
                                <label class="form-label fw-semibold">Date</label>
                                <input type="date" name="departure_date" class="form-control" required min="{{ today|date:'Y-m-d' }}">
                            </div>
                            <div class="col-6">
                                <label class="form-label fw-semibold">Time</label>
                                <input type="time" name="departure_time" class="form-control" required>
                            </div>
                        </div>
                        
                        <div class="row mt-3">
                            <div class="col-6">
                                <label class="form-label fw-semibold">Seats</label>
                                <select name="available_seats" class="form-control" required>
                                    <option value="">Select seats</option>
                                    <option value="1">1 seat</option>
                                    <option value="2">2 seats</option>
                                    <option value="3">3 seats</option>
                                    <option value="4">4 seats</option>
                                    <option value="5">5 seats</option>
                                    <option value="6">6 seats</option>
                                </select>
                            </div>
                            <div class="col-6">
                                <label class="form-label fw-semibold">Price per Seat</label>
                                <input type="number" name="price_per_seat" id="pricePerSeat" class="form-control" step="0.01" min="0" placeholder="25.00" required>
                            </div>
                        </div>
                        
                        <div class="mt-3">
                            <label class="form-label fw-semibold">Notes (Optional)</label>
                            <textarea name="notes" class="form-control" rows="2" placeholder="Additional information for passengers"></textarea>
                        </div>
                        
                        <div class="d-grid mt-4">
                            <button type="submit" class="btn btn-success btn-lg">üöó Create Ride</button>
                        </div>
                    </form>
                    
                    <hr class="my-4">
                    
                    <!-- Map Status -->
                    <div id="mapStatus" class="alert alert-info">
                        Click cities on the map to auto-fill the form
                    </div>
                    
                    <!-- Quick Actions -->
                    <div class="d-grid gap-2">
                        <button onclick="clearMapSelection()" class="btn btn-outline-secondary btn-sm">Clear Map Selection</button>
                        <a href="{% url 'accounts:driver_dashboard' %}" class="btn btn-outline-primary btn-sm">‚Üê Back to Dashboard</a>
                    </div>
                </div>
            </div>
            
            <!-- Existing Routes -->
            {% if user_routes %}
            <div class="card mt-3">
                <div class="card-header">
                    <h6>Your Previous Routes ({{ user_routes|length }})</h6>
                </div>
                <div class="card-body" style="max-height: 300px; overflow-y: auto;">
                    {% for route in user_routes %}
                    <div class="mb-2 p-2 border rounded">
                        <strong>{{ route.origin_city }} ‚Üí {{ route.destination_city }}</strong><br>
                        <small class="text-muted">${{ route.driver_price }} per seat</small>
                        <button onclick="useExistingRoute('{{ route.origin_city.id }}', '{{ route.destination_city.id }}', '{{ route.driver_price }}', '{{ route.origin_city.name }}', '{{ route.destination_city.name }}', {{ route.origin_city.latitude }}, {{ route.origin_city.longitude }}, {{ route.destination_city.latitude }}, {{ route.destination_city.longitude }})" 
                                class="btn btn-sm btn-outline-success float-end">Use This Route</button>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>
        
        <!-- Right Panel: Interactive Map -->
        <div class="col-md-8">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5>üåç Ontario Interactive Map</h5>
                    <div>
                        <button onclick="resetMapView()" class="btn btn-sm btn-secondary">Reset View</button>
                        <button onclick="zoomToOntario()" class="btn btn-sm btn-info">Zoom to Ontario</button>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div id="map" style="height: 600px; width: 100%;"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Leaflet CSS and JS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Google Places API -->
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC2b0BeI3xVs_jCfj7hjxqsv0CR-_VG2vw&libraries=places"></script>

<script>
// Map variables
let map;
let selectedOrigin = null;
let selectedDestination = null;
let cityMarkers = [];
let routeLine = null;

// Google Places Autocomplete
let pickupAutocomplete;
let dropoffAutocomplete;

// Initialize the map and Google Places
function initMap() {
    // Create map centered on Ontario
    map = L.map('map').setView([44.2619, -78.2628], 6);
    
    // Add OpenStreetMap tiles
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 18,
        attribution: '¬© OpenStreetMap contributors'
    }).addTo(map);
    
    // Add Ontario cities as markers
    const cities = [
        {% for city in cities %}
        {
            id: '{{ city.id }}',
            name: '{{ city.name }}',
            lat: {{ city.latitude }},
            lng: {{ city.longitude }}
        }{% if not forloop.last %},{% endif %}
        {% endfor %}
    ];
    
    // Add markers for each city
    cities.forEach(city => {
        const marker = L.marker([city.lat, city.lng])
            .addTo(map)
            .bindPopup(`<strong>${city.name}</strong><br><button onclick="selectCityFromMap('${city.id}', '${city.name}', ${city.lat}, ${city.lng})" class="btn btn-sm btn-primary">Select City</button>`);
        
        marker.cityData = city;
        cityMarkers.push(marker);
    });
    
    // Fit map to show all markers
    if (cityMarkers.length > 0) {
        const group = new L.featureGroup(cityMarkers);
        map.fitBounds(group.getBounds().pad(0.1));
    }
    
    // Initialize Google Places Autocomplete for Ontario
    initializeGooglePlaces();
}

// Initialize Google Places Autocomplete
function initializeGooglePlaces() {
    const ontarioBounds = new google.maps.LatLngBounds(
        new google.maps.LatLng(41.68, -95.16),
        new google.maps.LatLng(56.85, -74.34)
    );
    
    // Pickup location autocomplete
    pickupAutocomplete = new google.maps.places.Autocomplete(
        document.getElementById('pickupLocationInput'), {
            bounds: ontarioBounds,
            strictBounds: true,
            componentRestrictions: { country: "ca" },
            types: ["geocode"]
        }
    );
    
    // Drop-off location autocomplete
    dropoffAutocomplete = new google.maps.places.Autocomplete(
        document.getElementById('dropoffLocationInput'), {
            bounds: ontarioBounds,
            strictBounds: true,
            componentRestrictions: { country: "ca" },
            types: ["geocode"]
        }
    );
}

// Select city from map click
function selectCityFromMap(cityId, cityName, lat, lng) {
    if (!selectedOrigin) {
        // Select as origin
        selectedOrigin = {id: cityId, name: cityName, lat: lat, lng: lng};
        document.getElementById('originSelect').value = cityId;
        
        // Add origin marker
        L.marker([lat, lng], {
            icon: L.divIcon({
                className: 'origin-marker',
                html: '<div style="background: green; color: white; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; font-weight: bold;">O</div>',
                iconSize: [30, 30]
            })
        }).addTo(map).bindPopup(`<strong>Origin: ${cityName}</strong>`);
        
        updateMapStatus(`Origin: <strong>${cityName}</strong><br>Now select destination city`, 'warning');
        
    } else if (!selectedDestination && cityId !== selectedOrigin.id) {
        // Select as destination
        selectedDestination = {id: cityId, name: cityName, lat: lat, lng: lng};
        document.getElementById('destinationSelect').value = cityId;
        
        // Add destination marker
        L.marker([lat, lng], {
            icon: L.divIcon({
                className: 'destination-marker',
                html: '<div style="background: red; color: white; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; font-weight: bold;">D</div>',
                iconSize: [30, 30]
            })
        }).addTo(map).bindPopup(`<strong>Destination: ${cityName}</strong>`);
        
        // Draw route line
        drawRouteLine();
        
        updateMapStatus(`Route: <strong>${selectedOrigin.name} ‚Üí ${selectedDestination.name}</strong><br>Form auto-filled! Complete the details and create your ride.`, 'success');
        
    } else if (selectedDestination) {
        // Reset and start over
        clearMapSelection();
        selectCityFromMap(cityId, cityName, lat, lng);
    }
}

// Use existing route
function useExistingRoute(originId, destId, price, originName, destName, originLat, originLng, destLat, destLng) {
    // Clear current selection
    clearMapSelection();
    
    // Set form values
    document.getElementById('originSelect').value = originId;
    document.getElementById('destinationSelect').value = destId;
    document.getElementById('pricePerSeat').value = price;
    
    // Set map selection
    selectedOrigin = {id: originId, name: originName, lat: originLat, lng: originLng};
    selectedDestination = {id: destId, name: destName, lat: destLat, lng: destLng};
    
    // Add markers and draw route
    L.marker([originLat, originLng], {
        icon: L.divIcon({
            html: '<div style="background: green; color: white; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; font-weight: bold;">O</div>',
            iconSize: [30, 30]
        })
    }).addTo(map).bindPopup(`<strong>Origin: ${originName}</strong>`);
    
    L.marker([destLat, destLng], {
        icon: L.divIcon({
            html: '<div style="background: red; color: white; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; font-weight: bold;">D</div>',
            iconSize: [30, 30]
        })
    }).addTo(map).bindPopup(`<strong>Destination: ${destName}</strong>`);
    
    drawRouteLine();
    updateMapStatus(`Using existing route: <strong>${originName} ‚Üí ${destName}</strong> ($${price}/seat)<br>Complete the ride details and create your ride!`, 'info');
}

// Draw route line between cities
function drawRouteLine() {
    if (selectedOrigin && selectedDestination) {
        // Remove existing route line
        if (routeLine) {
            map.removeLayer(routeLine);
        }
        
        // Draw new route line
        routeLine = L.polyline([
            [selectedOrigin.lat, selectedOrigin.lng],
            [selectedDestination.lat, selectedDestination.lng]
        ], {
            color: 'blue',
            weight: 3,
            opacity: 0.7
        }).addTo(map);
        
        // Fit map to show the route
        map.fitBounds(routeLine.getBounds().pad(0.1));
    }
}

// Update map status
function updateMapStatus(message, type) {
    const statusDiv = document.getElementById('mapStatus');
    statusDiv.innerHTML = message;
    statusDiv.className = `alert alert-${type}`;
}

// Clear map selection
function clearMapSelection() {
    selectedOrigin = null;
    selectedDestination = null;
    document.getElementById('originSelect').value = '';
    document.getElementById('destinationSelect').value = '';
    
    // Clear map layers
    map.eachLayer(layer => {
        if (layer instanceof L.Marker && (layer.options.icon?.options.className === 'origin-marker' || layer.options.icon?.options.className === 'destination-marker')) {
            map.removeLayer(layer);
        }
    });
    
    if (routeLine) {
        map.removeLayer(routeLine);
        routeLine = null;
    }
    
    updateMapStatus('Click cities on the map to auto-fill the form', 'info');
}

// Reset map view
function resetMapView() {
    clearMapSelection();
    if (cityMarkers.length > 0) {
        const group = new L.featureGroup(cityMarkers);
        map.fitBounds(group.getBounds().pad(0.1));
    }
}

// Zoom to Ontario
function zoomToOntario() {
    map.setView([44.2619, -78.2628], 6);
}

// Form select changes
document.getElementById('originSelect').addEventListener('change', function(e) {
    const option = e.target.selectedOptions[0];
    if (option && option.dataset.lat) {
        const lat = parseFloat(option.dataset.lat);
        const lng = parseFloat(option.dataset.lng);
        const cityName = option.text;
        const cityId = option.value;
        
        if (cityId) {
            selectCityFromMap(cityId, cityName, lat, lng);
        }
    }
});

document.getElementById('destinationSelect').addEventListener('change', function(e) {
    const option = e.target.selectedOptions[0];
    if (option && option.dataset.lat && selectedOrigin) {
        const lat = parseFloat(option.dataset.lat);
        const lng = parseFloat(option.dataset.lng);
        const cityName = option.text;
        const cityId = option.value;
        
        if (cityId && cityId !== selectedOrigin.id) {
            selectCityFromMap(cityId, cityName, lat, lng);
        }
    }
});

// Initialize map when page loads
document.addEventListener('DOMContentLoaded', function() {
    initMap();
    
    // Set minimum date to today
    const today = new Date().toISOString().split('T')[0];
    document.querySelector('input[name="departure_date"]').setAttribute('min', today);
});
</script>
{% endblock %}